<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSR Analytics - LumenTrialGuide.AI</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #f9fafb;
    }
    .gradient-text {
      background: linear-gradient(90deg, #1a56db, #4f46e5);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      color: transparent;
    }
    .dashboard-card {
      transition: all 0.3s ease;
    }
    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
  </style>
</head>
<body>
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex items-center justify-between">
      <div class="flex items-center">
        <h1 class="text-3xl font-bold gradient-text">LumenTrialGuide.AI</h1>
      </div>
      <nav class="flex space-x-6">
        <a href="/csr-platform" class="font-medium text-gray-500 hover:text-indigo-600 px-1 py-2">CSR Platform</a>
        <a href="/api/csr/search" class="font-medium text-gray-500 hover:text-indigo-600 px-1 py-2">Search</a>
        <a href="/api/csr/analytics" class="font-medium text-indigo-600 border-b-2 border-indigo-600 px-1 py-2">Analytics</a>
        <a href="/spra-prod" class="font-medium text-gray-500 hover:text-indigo-600 px-1 py-2">SPRA Engine</a>
        <a href="/api/doc" class="font-medium text-gray-500 hover:text-indigo-600 px-1 py-2">API Docs</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="mb-12">
      <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl sm:tracking-tight mb-4">
        CSR Analytics Dashboard
      </h2>
      <p class="max-w-3xl text-xl text-gray-500">
        Visualize and analyze trends across clinical study reports to derive insights for better trial design and execution.
      </p>
    </div>

    <!-- Summary Stats -->
    <section class="mb-12">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white rounded-lg shadow p-6 dashboard-card">
          <h3 class="text-lg font-semibold text-gray-700 mb-2">Total CSRs</h3>
          <p class="text-4xl font-bold text-indigo-600" id="totalReports">3,021</p>
          <div class="mt-2 flex items-center">
            <span class="text-green-500 flex items-center text-sm">
              <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
              </svg>
              +8% this month
            </span>
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6 dashboard-card">
          <h3 class="text-lg font-semibold text-gray-700 mb-2">Processed CSRs</h3>
          <p class="text-4xl font-bold text-indigo-600" id="processedReports">853</p>
          <div class="mt-2 flex items-center">
            <span class="text-green-500 flex items-center text-sm">
              <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
              </svg>
              +12% this month
            </span>
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6 dashboard-card">
          <h3 class="text-lg font-semibold text-gray-700 mb-2">Therapeutic Areas</h3>
          <p class="text-4xl font-bold text-indigo-600" id="therapeuticAreas">42</p>
          <div class="mt-2 flex items-center">
            <span class="text-gray-500 flex items-center text-sm">
              <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
              </svg>
              No change
            </span>
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6 dashboard-card">
          <h3 class="text-lg font-semibold text-gray-700 mb-2">Avg. Endpoints</h3>
          <p class="text-4xl font-bold text-indigo-600" id="avgEndpoints">3.4</p>
          <div class="mt-2 flex items-center">
            <span class="text-green-500 flex items-center text-sm">
              <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
              </svg>
              +0.2 this month
            </span>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Charts -->
    <section class="mb-12">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-white rounded-lg shadow p-6 dashboard-card">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Phase Distribution</h3>
          <div class="h-64">
            <canvas id="phaseChart"></canvas>
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6 dashboard-card">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Therapeutic Areas</h3>
          <div class="h-64">
            <canvas id="therapeuticAreaChart"></canvas>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Upload Trends -->
    <section class="mb-12">
      <div class="bg-white rounded-lg shadow p-6 dashboard-card">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">CSR Upload Trends</h3>
          <div class="inline-flex rounded-md shadow-sm">
            <button type="button" class="timeframe-btn active py-2 px-4 border border-indigo-500 bg-indigo-100 text-indigo-700 font-medium rounded-l-md focus:z-10 focus:outline-none" data-timeframe="monthly">Monthly</button>
            <button type="button" class="timeframe-btn py-2 px-4 border border-gray-300 bg-white text-gray-700 font-medium focus:z-10 focus:outline-none" data-timeframe="weekly">Weekly</button>
            <button type="button" class="timeframe-btn py-2 px-4 border border-gray-300 bg-white text-gray-700 font-medium rounded-r-md focus:z-10 focus:outline-none" data-timeframe="quarterly">Quarterly</button>
          </div>
        </div>
        <div class="h-80">
          <canvas id="uploadTrendsChart"></canvas>
        </div>
      </div>
    </section>
    
    <!-- Endpoints Analysis -->
    <section class="mb-12">
      <div class="bg-white rounded-lg shadow p-6 dashboard-card">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Common Endpoints by Usage</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Endpoint</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Usage</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Primary</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Secondary</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Distribution</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="endpointsTable">
              <!-- This will be populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
    
    <!-- Sponsors Analysis -->
    <section class="mb-12">
      <div class="bg-white rounded-lg shadow p-6 dashboard-card">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Sponsors by CSR Count</h3>
        <div class="h-96">
          <canvas id="sponsorsChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Processing Status -->
    <section class="mb-12">
      <div class="bg-white rounded-lg shadow p-6 dashboard-card">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">CSR Processing Status</h3>
        <div class="h-64 flex items-center justify-center">
          <div class="w-64 h-64">
            <canvas id="processingStatusChart"></canvas>
          </div>
          <div class="ml-8 flex flex-col space-y-4">
            <div class="flex items-center">
              <span class="h-4 w-4 rounded-full bg-green-500 mr-2"></span>
              <span class="text-sm font-medium text-gray-700">Completed: <span id="completedCount">853</span></span>
            </div>
            <div class="flex items-center">
              <span class="h-4 w-4 rounded-full bg-yellow-500 mr-2"></span>
              <span class="text-sm font-medium text-gray-700">In Progress: <span id="inProgressCount">53</span></span>
            </div>
            <div class="flex items-center">
              <span class="h-4 w-4 rounded-full bg-gray-300 mr-2"></span>
              <span class="text-sm font-medium text-gray-700">Pending: <span id="pendingCount">168</span></span>
            </div>
            <div class="flex items-center">
              <span class="h-4 w-4 rounded-full bg-red-500 mr-2"></span>
              <span class="text-sm font-medium text-gray-700">Failed: <span id="failedCount">47</span></span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-gray-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div class="md:flex md:items-center md:justify-between">
        <div>
          <h3 class="text-xl font-bold gradient-text mb-4">LumenTrialGuide.AI</h3>
          <p class="text-gray-500 max-w-md">
            The intelligent platform that transforms clinical study reports into actionable insights for better trial design and execution.
          </p>
        </div>
        <div class="mt-8 md:mt-0">
          <h3 class="text-sm font-semibold text-gray-700 tracking-wider uppercase mb-4">Navigation</h3>
          <ul class="space-y-4">
            <li>
              <a href="/csr-platform" class="text-gray-500 hover:text-gray-700">CSR Platform</a>
            </li>
            <li>
              <a href="/api/csr/search" class="text-gray-500 hover:text-gray-700">Search</a>
            </li>
            <li>
              <a href="/api/csr/analytics" class="text-gray-500 hover:text-gray-700">Analytics</a>
            </li>
            <li>
              <a href="/spra-prod" class="text-gray-500 hover:text-gray-700">SPRA Engine</a>
            </li>
            <li>
              <a href="/api/doc" class="text-gray-500 hover:text-gray-700">API Documentation</a>
            </li>
          </ul>
        </div>
      </div>
      <div class="mt-12 border-t border-gray-200 pt-8">
        <p class="text-gray-400 text-sm text-center">
          &copy; 2025 LumenTrialGuide.AI. All rights reserved.
        </p>
      </div>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log("CSR Analytics Dashboard loaded successfully");
      
      // Fetch summary data
      fetch('/api/analytics/summary')
        .then(response => response.json())
        .then(data => {
          document.getElementById('totalReports').textContent = data.totalReports.toLocaleString();
          document.getElementById('processedReports').textContent = data.processedReports.toLocaleString();
          document.getElementById('therapeuticAreas').textContent = data.therapeuticAreas.toLocaleString();
          document.getElementById('avgEndpoints').textContent = data.averageEndpoints;
          
          // Update processing status
          document.getElementById('completedCount').textContent = data.processingStats.completed.toLocaleString();
          document.getElementById('inProgressCount').textContent = data.processingStats.inProgress.toLocaleString();
          document.getElementById('pendingCount').textContent = data.processingStats.pending.toLocaleString();
          document.getElementById('failedCount').textContent = data.processingStats.failed.toLocaleString();
          
          // Initialize processing status chart
          const processingStatusCtx = document.getElementById('processingStatusChart').getContext('2d');
          new Chart(processingStatusCtx, {
            type: 'doughnut',
            data: {
              labels: ['Completed', 'In Progress', 'Pending', 'Failed'],
              datasets: [{
                data: [
                  data.processingStats.completed, 
                  data.processingStats.inProgress, 
                  data.processingStats.pending, 
                  data.processingStats.failed
                ],
                backgroundColor: ['#10B981', '#F59E0B', '#E5E7EB', '#EF4444'],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                }
              }
            }
          });
        })
        .catch(error => {
          console.error('Error fetching summary data:', error);
        });
      
      // Fetch phase distribution data
      fetch('/api/analytics/phases')
        .then(response => response.json())
        .then(data => {
          const labels = data.map(item => item.phase);
          const counts = data.map(item => item.count);
          
          const phaseCtx = document.getElementById('phaseChart').getContext('2d');
          new Chart(phaseCtx, {
            type: 'doughnut',
            data: {
              labels: labels,
              datasets: [{
                data: counts,
                backgroundColor: [
                  '#818cf8', // indigo-400
                  '#6366f1', // indigo-500
                  '#4f46e5', // indigo-600
                  '#4338ca', // indigo-700
                  '#3730a3', // indigo-800
                  '#312e81'  // indigo-900
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'right',
                }
              }
            }
          });
        })
        .catch(error => {
          console.error('Error fetching phase distribution:', error);
        });
      
      // Fetch therapeutic area distribution data
      fetch('/api/analytics/therapeutic-areas')
        .then(response => response.json())
        .then(data => {
          // Sort by count in descending order
          data.sort((a, b) => b.count - a.count);
          
          // Take only top 10
          const topAreas = data.slice(0, 10);
          
          const labels = topAreas.map(item => item.area);
          const counts = topAreas.map(item => item.count);
          
          const areaCtx = document.getElementById('therapeuticAreaChart').getContext('2d');
          new Chart(areaCtx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Number of CSRs',
                data: counts,
                backgroundColor: '#4f46e5', // indigo-600
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false,
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'CSR Count'
                  }
                },
                x: {
                  ticks: {
                    callback: function(value) {
                      const label = this.getLabelForValue(value);
                      return label.length > 10 ? label.substring(0, 10) + '...' : label;
                    }
                  }
                }
              }
            }
          });
        })
        .catch(error => {
          console.error('Error fetching therapeutic area distribution:', error);
        });
      
      // Fetch upload trends data (default: monthly)
      function fetchUploadTrends(timeframe = 'monthly') {
        fetch(`/api/analytics/upload-trends?timeframe=${timeframe}`)
          .then(response => response.json())
          .then(data => {
            const labels = data.map(item => item.period);
            const counts = data.map(item => item.count);
            
            // Clear previous chart if exists
            if (window.uploadTrendsChart) {
              window.uploadTrendsChart.destroy();
            }
            
            const trendsCtx = document.getElementById('uploadTrendsChart').getContext('2d');
            window.uploadTrendsChart = new Chart(trendsCtx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: 'CSR Uploads',
                  data: counts,
                  borderColor: '#4f46e5',
                  backgroundColor: 'rgba(79, 70, 229, 0.1)',
                  fill: true,
                  tension: 0.4,
                  borderWidth: 3,
                  pointBackgroundColor: '#4f46e5',
                  pointRadius: 4
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: 'Number of Uploads'
                    }
                  },
                  x: {
                    grid: {
                      display: false
                    }
                  }
                }
              }
            });
          })
          .catch(error => {
            console.error('Error fetching upload trends:', error);
          });
      }
      
      // Initialize with monthly data
      fetchUploadTrends();
      
      // Add event listeners to timeframe buttons
      document.querySelectorAll('.timeframe-btn').forEach(button => {
        button.addEventListener('click', function() {
          // Remove active class from all buttons
          document.querySelectorAll('.timeframe-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-indigo-100', 'text-indigo-700', 'border-indigo-500');
            btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
          });
          
          // Add active class to clicked button
          this.classList.add('active', 'bg-indigo-100', 'text-indigo-700', 'border-indigo-500');
          this.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
          
          // Fetch data for selected timeframe
          fetchUploadTrends(this.dataset.timeframe);
        });
      });
      
      // Fetch endpoints data
      fetch('/api/analytics/endpoints')
        .then(response => response.json())
        .then(data => {
          const endpointsTable = document.getElementById('endpointsTable');
          endpointsTable.innerHTML = ''; // Clear table
          
          data.forEach(endpoint => {
            const row = document.createElement('tr');
            
            // Calculate percentage of primary vs secondary
            const primaryPercentage = Math.round((endpoint.primaryUse / endpoint.count) * 100);
            const secondaryPercentage = 100 - primaryPercentage;
            
            row.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${endpoint.name}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${endpoint.count}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${endpoint.primaryUse} (${primaryPercentage}%)</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${endpoint.secondaryUse} (${secondaryPercentage}%)</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                  <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${primaryPercentage}%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                  <span>Primary</span>
                  <span>Secondary</span>
                </div>
              </td>
            `;
            
            endpointsTable.appendChild(row);
          });
        })
        .catch(error => {
          console.error('Error fetching endpoints data:', error);
        });
      
      // Fetch sponsors data
      fetch('/api/analytics/sponsors')
        .then(response => response.json())
        .then(data => {
          // Sort by count in descending order
          data.sort((a, b) => b.count - a.count);
          
          // Take only top 10
          const topSponsors = data.slice(0, 10);
          
          const labels = topSponsors.map(item => item.name);
          const counts = topSponsors.map(item => item.count);
          
          const sponsorsCtx = document.getElementById('sponsorsChart').getContext('2d');
          new Chart(sponsorsCtx, {
            type: 'horizontalBar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Number of CSRs',
                data: counts,
                backgroundColor: [
                  '#c7d2fe', // indigo-200
                  '#a5b4fc', // indigo-300
                  '#818cf8', // indigo-400
                  '#6366f1', // indigo-500
                  '#4f46e5', // indigo-600
                  '#4338ca', // indigo-700
                  '#3730a3', // indigo-800
                  '#312e81', // indigo-900
                  '#818cf8', // indigo-400
                  '#6366f1', // indigo-500
                ],
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false,
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'CSR Count'
                  }
                }
              }
            }
          });
        })
        .catch(error => {
          console.error('Error fetching sponsors data:', error);
          
          // Fallback to display a simple chart with sample data if API fails
          const sponsorsCtx = document.getElementById('sponsorsChart').getContext('2d');
          new Chart(sponsorsCtx, {
            type: 'horizontalBar',
            data: {
              labels: [
                'PharmaGlobal Therapeutics',
                'BioInnovate Sciences',
                'MediVector Research',
                'NovaTech Pharmaceuticals',
                'CellGenics Bioscience'
              ],
              datasets: [{
                label: 'Number of CSRs (Sample)',
                data: [245, 218, 187, 165, 142],
                backgroundColor: [
                  '#c7d2fe', // indigo-200
                  '#a5b4fc', // indigo-300
                  '#818cf8', // indigo-400
                  '#6366f1', // indigo-500
                  '#4f46e5', // indigo-600
                ],
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false,
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'CSR Count'
                  }
                }
              }
            }
          });
        });
    });
  </script>
</body>
</html>