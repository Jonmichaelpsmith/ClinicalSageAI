<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LumenTrialGuide.AI - SPRA Console</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --primary-hover: #1e40af;
      --bg-light: #f9fafb;
      --bg-dark: #1f2937;
      --text-light: #374151;
      --text-dark: #f3f4f6;
      --border-light: #e5e7eb;
      --border-dark: #4b5563;
      --success: #059669;
      --warning: #d97706;
      --danger: #dc2626;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 
        'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: var(--bg-light);
      color: var(--text-light);
      line-height: 1.5;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    header {
      background-color: white;
      border-bottom: 1px solid var(--border-light);
      padding: 1rem 0;
      margin-bottom: 2rem;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      background: linear-gradient(to right, var(--primary), var(--primary-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    nav a {
      margin-left: 1rem;
      color: var(--text-light);
      text-decoration: none;
      font-weight: 500;
    }

    nav a:hover {
      color: var(--primary);
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border-light);
    }

    h1, h2, h3 {
      margin-top: 0;
      color: var(--text-light);
    }

    h1 {
      font-size: 1.75rem;
      margin-bottom: 1.5rem;
    }

    h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 0.5rem;
      color: var(--primary-dark);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-light);
      border-radius: 0.25rem;
      font-size: 1rem;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
    }

    button {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 0.25rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: var(--primary-hover);
    }

    button:disabled {
      background-color: var(--border-light);
      cursor: not-allowed;
    }

    .button-secondary {
      background-color: white;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .button-secondary:hover {
      background-color: var(--bg-light);
    }

    .protocol-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 640px) {
      .protocol-form {
        grid-template-columns: 1fr;
      }
    }

    .form-actions {
      grid-column: span 2;
      margin-top: 1rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    @media (max-width: 640px) {
      .form-actions {
        grid-column: span 1;
      }
    }

    .result-card {
      min-height: 300px;
      overflow: auto;
    }

    pre {
      background-color: var(--bg-light);
      padding: 1rem;
      border-radius: 0.25rem;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.875rem;
      border: 1px solid var(--border-light);
    }

    .spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-left: 0.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status {
      margin-top: 1rem;
      padding: 0.5rem;
      border-radius: 0.25rem;
      font-weight: 500;
    }

    .status.loading {
      background-color: #e9f0fe;
      color: var(--primary);
    }

    .status.success {
      background-color: #ecfdf5;
      color: var(--success);
    }

    .status.error {
      background-color: #fef2f2;
      color: var(--danger);
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .metric {
      background-color: white;
      border-radius: 0.25rem;
      padding: 1rem;
      border: 1px solid var(--border-light);
      text-align: center;
    }

    .metric-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0.5rem 0;
    }

    .metric-label {
      font-size: 0.875rem;
      color: var(--text-light);
    }

    .gauge-container {
      position: relative;
      width: 100px;
      height: 50px;
      margin: 0 auto;
      overflow: hidden;
    }

    .gauge {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 8px solid var(--border-light);
      border-top-color: var(--primary);
      border-right-color: var(--primary);
      border-left-color: var(--primary);
      transform: rotate(0deg);
      transition: transform 0.5s ease-in-out;
    }

    .gauge-value {
      position: absolute;
      top: 60%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.25rem;
      font-weight: 700;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
    }

    th {
      font-weight: 600;
      color: var(--text-light);
    }

    .table-container {
      overflow-x: auto;
    }

    footer {
      margin-top: 2rem;
      padding: 1rem 0;
      border-top: 1px solid var(--border-light);
      text-align: center;
      font-size: 0.875rem;
      color: var(--text-light);
    }

    .insights-container {
      margin-top: 1rem;
    }

    .insights-section {
      margin-bottom: 1rem;
    }

    .insights-list {
      list-style-type: none;
      padding-left: 0;
      margin-bottom: 1rem;
    }

    .insights-list li {
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border-light);
    }

    .insights-list li:last-child {
      border-bottom: none;
    }

    .toggle-button {
      display: inline-block;
      background: none;
      border: none;
      color: var(--primary);
      padding: 0;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 0.5rem;
    }

    .toggle-button:hover {
      text-decoration: underline;
      background: none;
    }

    .toggle-button:focus {
      outline: none;
    }

    .hidden {
      display: none;
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
      background-color: var(--primary-light);
      color: white;
      margin-left: 0.25rem;
    }

    .status-indicator {
      display: inline-block;
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      margin-right: 0.5rem;
    }

    .status-active {
      background-color: var(--success);
    }

    .status-error {
      background-color: var(--danger);
    }

    /* Custom slider styling */
    .range-slider {
      position: relative;
      width: 100%;
      height: 2rem;
    }

    .range-slider input {
      width: 100%;
      height: 0.5rem;
      background: var(--border-light);
      border-radius: 0.25rem;
      outline: none;
      -webkit-appearance: none;
    }

    .range-slider input::-webkit-slider-thumb {
      appearance: none;
      width: 1rem;
      height: 1rem;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
    }

    .range-slider input::-moz-range-thumb {
      width: 1rem;
      height: 1rem;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: none;
    }

    .slider-value {
      position: absolute;
      top: 1.5rem;
      color: var(--text-light);
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <div class="logo">LumenTrialGuide.AI</div>
      <nav>
        <a href="#">Protocol Advisor</a>
        <a href="#">CSR Library</a>
        <a href="#">Documentation</a>
      </nav>
    </div>
  </header>

  <div class="container">
    <h1>Strategic Protocol Recommendations Advisor</h1>
    
    <div class="main-content">
      <div class="input-section">
        <div class="card">
          <h2>Protocol Parameters</h2>
          <div class="protocol-form">
            <div class="form-group">
              <label for="sample-size">Sample Size</label>
              <input type="number" id="sample-size" min="10" max="1000" value="200">
            </div>
            <div class="form-group">
              <label for="duration">Duration (weeks)</label>
              <input type="number" id="duration" min="4" max="260" value="52">
            </div>
            <div class="form-group">
              <label for="therapeutic-area">Therapeutic Area</label>
              <select id="therapeutic-area">
                <option value="Oncology">Oncology</option>
                <option value="Cardiology">Cardiology</option>
                <option value="Neurology">Neurology</option>
                <option value="Immunology">Immunology</option>
                <option value="Infectious Disease">Infectious Disease</option>
                <option value="Respiratory">Respiratory</option>
                <option value="Gastroenterology">Gastroenterology</option>
                <option value="Endocrinology">Endocrinology</option>
                <option value="Dermatology">Dermatology</option>
                <option value="Psychiatry">Psychiatry</option>
                <option value="Rheumatology">Rheumatology</option>
                <option value="Urology">Urology</option>
                <option value="Ophthalmology">Ophthalmology</option>
              </select>
            </div>
            <div class="form-group">
              <label for="phase">Study Phase</label>
              <select id="phase">
                <option value="Phase 1">Phase 1</option>
                <option value="Phase 1/2">Phase 1/2</option>
                <option value="Phase 2" selected>Phase 2</option>
                <option value="Phase 2/3">Phase 2/3</option>
                <option value="Phase 3">Phase 3</option>
                <option value="Phase 4">Phase 4</option>
              </select>
            </div>
            <div class="form-group">
              <label for="randomization">Randomization</label>
              <select id="randomization">
                <option value="Double-blind" selected>Double-blind</option>
                <option value="Single-blind">Single-blind</option>
                <option value="Open-label">Open-label</option>
                <option value="Non-randomized">Non-randomized</option>
              </select>
            </div>
            <div class="form-group">
              <label for="primary-endpoint">Primary Endpoint</label>
              <input type="text" id="primary-endpoint" value="Overall Survival">
            </div>
            <div class="form-actions">
              <button id="reset-button" class="button-secondary">Reset</button>
              <button id="analyze-button">Analyze Protocol <span id="loading-spinner" class="spinner hidden"></span></button>
            </div>
          </div>
        </div>

        <div class="card" id="api-status-card">
          <h2>API Status</h2>
          <div id="api-status">
            <div>Checking API status...</div>
          </div>
          <div class="form-group" style="margin-top: 1rem;">
            <button id="check-api-button" class="button-secondary">Check API Status</button>
          </div>
        </div>
      </div>

      <div class="results-section">
        <div class="card result-card">
          <h2>Analysis Results</h2>
          <div id="results-placeholder">
            Enter protocol parameters and click "Analyze Protocol" to see results.
          </div>
          <div id="results-content" class="hidden">
            <div class="metrics">
              <div class="metric">
                <div class="metric-label">Success Probability</div>
                <div class="gauge-container">
                  <div id="success-gauge" class="gauge"></div>
                  <div id="success-value" class="gauge-value">0%</div>
                </div>
              </div>
              <div class="metric">
                <div class="metric-label">Recommended Sample Size</div>
                <div id="sample-size-value" class="metric-value">-</div>
                <div class="metric-label">patients</div>
              </div>
              <div class="metric">
                <div class="metric-label">Recommended Duration</div>
                <div id="duration-value" class="metric-value">-</div>
                <div class="metric-label">weeks</div>
              </div>
              <div class="metric">
                <div class="metric-label">Similar Trials</div>
                <div id="similar-trials-value" class="metric-value">-</div>
                <div class="metric-label">analyzed</div>
              </div>
            </div>

            <div class="insights-container">
              <h3>Therapeutic Insights</h3>
              <div class="insights-section">
                <button id="toggle-endpoints" class="toggle-button">+ Common Endpoints</button>
                <ul id="endpoints-list" class="insights-list hidden"></ul>
              </div>
              <div class="insights-section">
                <button id="toggle-inclusion" class="toggle-button">+ Common Inclusion Criteria</button>
                <ul id="inclusion-list" class="insights-list hidden"></ul>
              </div>
              <div class="insights-section">
                <button id="toggle-exclusion" class="toggle-button">+ Common Exclusion Criteria</button>
                <ul id="exclusion-list" class="insights-list hidden"></ul>
              </div>
              <div class="insights-section">
                <button id="toggle-challenges" class="toggle-button">+ Typical Challenges</button>
                <ul id="challenges-list" class="insights-list hidden"></ul>
              </div>
              <div class="insights-section">
                <button id="toggle-success-factors" class="toggle-button">+ Success Factors</button>
                <ul id="success-factors-list" class="insights-list hidden"></ul>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>JSON Response</h2>
          <pre id="response-json">No data yet</pre>
        </div>
      </div>
    </div>
  </div>

  <footer class="container">
    <p>&copy; 2025 LumenTrialGuide.AI - Strategic Protocol Recommendations Advisor (SPRA)</p>
  </footer>

  <script>
    // DOM elements
    const analyzeButton = document.getElementById('analyze-button');
    const resetButton = document.getElementById('reset-button');
    const checkApiButton = document.getElementById('check-api-button');
    const loadingSpinner = document.getElementById('loading-spinner');
    const apiStatus = document.getElementById('api-status');
    const resultsPlaceholder = document.getElementById('results-placeholder');
    const resultsContent = document.getElementById('results-content');
    const responseJson = document.getElementById('response-json');
    
    // Results elements
    const successGauge = document.getElementById('success-gauge');
    const successValue = document.getElementById('success-value');
    const sampleSizeValue = document.getElementById('sample-size-value');
    const durationValue = document.getElementById('duration-value');
    const similarTrialsValue = document.getElementById('similar-trials-value');
    
    // Toggle buttons and lists
    const toggleEndpoints = document.getElementById('toggle-endpoints');
    const endpointsList = document.getElementById('endpoints-list');
    const toggleInclusion = document.getElementById('toggle-inclusion');
    const inclusionList = document.getElementById('inclusion-list');
    const toggleExclusion = document.getElementById('toggle-exclusion');
    const exclusionList = document.getElementById('exclusion-list');
    const toggleChallenges = document.getElementById('toggle-challenges');
    const challengesList = document.getElementById('challenges-list');
    const toggleSuccessFactors = document.getElementById('toggle-success-factors');
    const successFactorsList = document.getElementById('success-factors-list');
    
    // Add toggle functionality
    function setupToggle(button, list) {
      button.addEventListener('click', () => {
        const isHidden = list.classList.contains('hidden');
        list.classList.toggle('hidden');
        button.textContent = isHidden ? '- ' + button.textContent.substring(2) : '+ ' + button.textContent.substring(2);
      });
    }
    
    setupToggle(toggleEndpoints, endpointsList);
    setupToggle(toggleInclusion, inclusionList);
    setupToggle(toggleExclusion, exclusionList);
    setupToggle(toggleChallenges, challengesList);
    setupToggle(toggleSuccessFactors, successFactorsList);
    
    // Check API status on page load
    checkApiStatus();
    
    // Check API button click handler
    checkApiButton.addEventListener('click', checkApiStatus);
    
    // Check API status function
    function checkApiStatus() {
      apiStatus.innerHTML = '<div>Checking API status...</div>';
      
      fetch('/api/spra/direct-health')
        .then(response => {
          if (!response.ok) throw new Error('API returned status ' + response.status);
          return response.json();
        })
        .then(data => {
          apiStatus.innerHTML = `
            <div><span class="status-indicator status-active"></span> API is operational</div>
            <div style="margin-top: 0.5rem; font-size: 0.875rem;">Version: ${data.version || '1.0'}</div>
            <div style="margin-top: 0.25rem; font-size: 0.875rem;">Last checked: ${new Date().toLocaleTimeString()}</div>
          `;
        })
        .catch(error => {
          apiStatus.innerHTML = `
            <div><span class="status-indicator status-error"></span> API error</div>
            <div style="margin-top: 0.5rem; color: var(--danger);">${error.message}</div>
            <div style="margin-top: 0.25rem; font-size: 0.875rem;">Last checked: ${new Date().toLocaleTimeString()}</div>
          `;
        });
    }
    
    // Analyze button click handler
    analyzeButton.addEventListener('click', analyzeProtocol);
    
    // Reset button click handler
    resetButton.addEventListener('click', () => {
      document.getElementById('sample-size').value = '200';
      document.getElementById('duration').value = '52';
      document.getElementById('therapeutic-area').value = 'Oncology';
      document.getElementById('phase').value = 'Phase 2';
      document.getElementById('randomization').value = 'Double-blind';
      document.getElementById('primary-endpoint').value = 'Overall Survival';
      
      // Hide results
      resultsPlaceholder.classList.remove('hidden');
      resultsContent.classList.add('hidden');
      responseJson.textContent = 'No data yet';
    });
    
    // Analyze protocol function
    function analyzeProtocol() {
      // Show loading spinner
      loadingSpinner.classList.remove('hidden');
      analyzeButton.disabled = true;
      
      // Get form values
      const sampleSize = parseInt(document.getElementById('sample-size').value, 10);
      const duration = parseInt(document.getElementById('duration').value, 10);
      const therapeuticArea = document.getElementById('therapeutic-area').value;
      const phase = document.getElementById('phase').value;
      const randomization = document.getElementById('randomization').value;
      const primaryEndpoint = document.getElementById('primary-endpoint').value;
      
      // Validate form values
      if (!sampleSize || !duration) {
        alert('Please enter valid numbers for sample size and duration.');
        loadingSpinner.classList.add('hidden');
        analyzeButton.disabled = false;
        return;
      }
      
      // Prepare request body
      const requestBody = {
        sample_size: sampleSize,
        duration: duration,
        therapeutic_area: therapeuticArea,
        phase: phase,
        randomization: randomization,
        primary_endpoint: primaryEndpoint
      };
      
      // Make API request
      fetch('/api/spra/direct-analyze', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      })
        .then(response => {
          if (!response.ok) throw new Error('API returned status ' + response.status);
          return response.json();
        })
        .then(data => {
          // Display JSON response
          responseJson.textContent = JSON.stringify(data, null, 2);
          
          // Show results content
          resultsPlaceholder.classList.add('hidden');
          resultsContent.classList.remove('hidden');
          
          // Update metrics
          updateSuccessGauge(data.prediction || 0.5);
          sampleSizeValue.textContent = data.best_sample_size || data.recommendations?.sample_size?.recommended || '-';
          durationValue.textContent = data.best_duration || data.recommendations?.duration?.recommended || '-';
          similarTrialsValue.textContent = data.insights?.total_trials || data.data_sources?.similar_trials_analyzed || '-';
          
          // Update insights lists
          updateList(endpointsList, data.therapeutic_insights?.common_endpoints || []);
          updateList(inclusionList, data.therapeutic_insights?.common_inclusion_criteria || []);
          updateList(exclusionList, data.therapeutic_insights?.common_exclusion_criteria || []);
          updateList(challengesList, data.therapeutic_insights?.typical_challenges || []);
          updateList(successFactorsList, data.therapeutic_insights?.success_factors || []);
        })
        .catch(error => {
          responseJson.textContent = 'Error: ' + error.message;
          
          // Show error status
          apiStatus.innerHTML = `
            <div><span class="status-indicator status-error"></span> API error</div>
            <div style="margin-top: 0.5rem; color: var(--danger);">${error.message}</div>
            <div style="margin-top: 0.25rem; font-size: 0.875rem;">Last checked: ${new Date().toLocaleTimeString()}</div>
          `;
        })
        .finally(() => {
          // Hide loading spinner and re-enable button
          loadingSpinner.classList.add('hidden');
          analyzeButton.disabled = false;
        });
    }
    
    // Update success gauge
    function updateSuccessGauge(probability) {
      const value = typeof probability === 'object' ? (probability.success_probability || 0.5) : probability;
      const percent = Math.round(value * 100);
      const degrees = Math.min(180, Math.max(0, value * 180));
      
      successGauge.style.transform = `rotate(${degrees}deg)`;
      successValue.textContent = `${percent}%`;
    }
    
    // Update list with items
    function updateList(listElement, items) {
      listElement.innerHTML = '';
      
      if (!items || items.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'No data available';
        listElement.appendChild(li);
        return;
      }
      
      items.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        listElement.appendChild(li);
      });
    }
  </script>
</body>
</html>