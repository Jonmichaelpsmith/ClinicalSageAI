<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Strategic Protocol Recommendations Advisor | LumenTrialGuide.AI</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --primary-light: #3b82f6;
      --bg-light: #f9fafb;
      --text-dark: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.5;
      color: var(--text-dark);
      background-color: var(--bg-light);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    
    header {
      background-color: white;
      border-bottom: 1px solid var(--border);
      padding: 1rem 0;
    }
    
    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
      background: linear-gradient(45deg, var(--primary), var(--primary-light));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    nav a {
      color: var(--text-dark);
      text-decoration: none;
      margin-left: 1.5rem;
      font-weight: 500;
      transition: color 0.2s;
    }
    
    nav a:hover {
      color: var(--primary);
    }
    
    .page-title {
      font-size: 2rem;
      font-weight: 800;
      margin: 2rem 0;
      color: var(--text-dark);
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 3rem;
    }
    
    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
      border: 1px solid var(--border);
      margin-bottom: 1.5rem;
    }
    
    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary-light);
      color: var(--primary-hover);
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 0.625rem;
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      font-size: 1rem;
      font-family: inherit;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    @media (max-width: 640px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }
    
    button {
      padding: 0.625rem 1.25rem;
      font-size: 1rem;
      font-weight: 500;
      border-radius: 0.375rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background-color: var(--primary-hover);
    }
    
    .btn-secondary {
      background-color: white;
      color: var(--text-dark);
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover:not(:disabled) {
      background-color: var(--bg-light);
    }
    
    .loader {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: loader-spin 1s linear infinite;
      margin-left: 0.5rem;
    }
    
    @keyframes loader-spin {
      to { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    pre {
      background-color: #f8f9fa;
      padding: 1rem;
      border-radius: 0.375rem;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.875rem;
      line-height: 1.7;
      color: #1e293b;
      border: 1px solid #e2e8f0;
    }
    
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .metric {
      background-color: white;
      border-radius: 0.5rem;
      padding: 1.25rem;
      border: 1px solid var(--border);
      text-align: center;
    }
    
    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0.5rem 0;
    }
    
    .metric-label {
      font-size: 0.875rem;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    .insights-container {
      margin-top: 1.5rem;
    }
    
    .insight-section {
      margin-bottom: 1rem;
    }
    
    .insight-toggle {
      background: none;
      border: none;
      color: var(--primary);
      padding: 0;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      text-align: left;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    
    .insight-toggle:hover {
      color: var(--primary-hover);
    }
    
    .insight-content {
      margin-top: 0.5rem;
      padding: 0.5rem 0;
    }
    
    .insight-list {
      list-style-type: none;
      padding-left: 0;
    }
    
    .insight-list li {
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    
    .insight-list li:last-child {
      border-bottom: none;
    }
    
    .success-probability {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 0 auto;
    }
    
    .gauge {
      position: relative;
      width: 100%;
      height: 100%;
    }
    
    .gauge-background {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background-color: #e5e7eb;
      position: absolute;
    }
    
    .gauge-fill {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      clip: rect(0, 120px, 120px, 60px);
      position: absolute;
      background-color: var(--primary);
      transform-origin: center;
      transition: transform 0.5s ease-out;
    }
    
    .gauge-cover {
      width: 90px;
      height: 90px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 15px;
      left: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.5rem;
      color: var(--text-dark);
    }
    
    .api-status {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .status-dot {
      display: inline-block;
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
    
    .status-dot.active {
      background-color: var(--success);
    }
    
    .status-dot.error {
      background-color: var(--danger);
    }
    
    .status-text {
      font-weight: 500;
    }
    
    .status-info {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }
    
    footer {
      background-color: white;
      border-top: 1px solid var(--border);
      padding: 2rem 0;
      color: var(--text-muted);
      font-size: 0.875rem;
    }
    
    .footer-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    @media (max-width: 640px) {
      .footer-container {
        flex-direction: column;
        gap: 1rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <div class="logo">LumenTrialGuide.AI</div>
      <nav>
        <a href="#">SPRA</a>
        <a href="#">CSR Library</a>
        <a href="#">Documentation</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1 class="page-title">Strategic Protocol Recommendations Advisor</h1>
    
    <div class="main-content">
      <div class="input-section">
        <div class="card">
          <h2 class="card-title">Protocol Parameters</h2>
          <form id="protocol-form">
            <div class="form-grid">
              <div class="form-group">
                <label for="sample-size">Sample Size</label>
                <input type="number" id="sample-size" name="sample_size" min="10" max="2000" value="250" required>
              </div>
              <div class="form-group">
                <label for="duration">Duration (weeks)</label>
                <input type="number" id="duration" name="duration" min="4" max="260" value="52" required>
              </div>
              <div class="form-group">
                <label for="therapeutic-area">Therapeutic Area</label>
                <select id="therapeutic-area" name="therapeutic_area" required>
                  <option value="Oncology">Oncology</option>
                  <option value="Cardiovascular">Cardiovascular</option>
                  <option value="Neurology">Neurology</option>
                  <option value="Immunology">Immunology</option>
                  <option value="Infectious Disease">Infectious Disease</option>
                  <option value="Respiratory">Respiratory</option>
                  <option value="Gastroenterology">Gastroenterology</option>
                  <option value="Endocrinology">Endocrinology</option>
                  <option value="Dermatology">Dermatology</option>
                  <option value="Rheumatology">Rheumatology</option>
                  <option value="Psychiatry">Psychiatry</option>
                  <option value="Ophthalmology">Ophthalmology</option>
                  <option value="Hematology">Hematology</option>
                </select>
              </div>
              <div class="form-group">
                <label for="phase">Study Phase</label>
                <select id="phase" name="phase" required>
                  <option value="Phase 1">Phase 1</option>
                  <option value="Phase 1/2">Phase 1/2</option>
                  <option value="Phase 2" selected>Phase 2</option>
                  <option value="Phase 2/3">Phase 2/3</option>
                  <option value="Phase 3">Phase 3</option>
                  <option value="Phase 4">Phase 4</option>
                </select>
              </div>
              <div class="form-group">
                <label for="randomization">Randomization</label>
                <select id="randomization" name="randomization" required>
                  <option value="Double-blind" selected>Double-blind</option>
                  <option value="Single-blind">Single-blind</option>
                  <option value="Open-label">Open-label</option>
                  <option value="Non-randomized">Non-randomized</option>
                </select>
              </div>
              <div class="form-group">
                <label for="primary-endpoint">Primary Endpoint</label>
                <input type="text" id="primary-endpoint" name="primary_endpoint" value="Overall Response Rate">
              </div>
            </div>
            <div class="form-actions">
              <button type="button" id="reset-button" class="btn-secondary">Reset</button>
              <button type="submit" id="analyze-button" class="btn-primary">
                Analyze Protocol
                <span id="loader" class="loader hidden"></span>
              </button>
            </div>
          </form>
        </div>
        
        <div class="card">
          <h2 class="card-title">API Status</h2>
          <div id="api-status-container">
            <div class="api-status">
              <span class="status-dot active"></span>
              <span class="status-text">Checking API status...</span>
            </div>
          </div>
          <button id="check-api-button" class="btn-secondary">Refresh Status</button>
        </div>
      </div>
      
      <div class="results-section">
        <div class="card">
          <h2 class="card-title">Analysis Results</h2>
          <div id="results-placeholder">
            Enter protocol parameters and click "Analyze Protocol" to see recommendations based on similar clinical trials.
          </div>
          <div id="results-content" class="hidden">
            <div class="metrics">
              <div class="metric">
                <div class="metric-label">Success Probability</div>
                <div class="success-probability">
                  <div class="gauge">
                    <div class="gauge-background"></div>
                    <div id="gauge-fill" class="gauge-fill"></div>
                    <div class="gauge-cover">
                      <span id="success-probability-value">0%</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="metric">
                <div class="metric-label">Recommended Sample Size</div>
                <div id="sample-size-value" class="metric-value">-</div>
                <div class="metric-label">patients</div>
              </div>
              <div class="metric">
                <div class="metric-label">Recommended Duration</div>
                <div id="duration-value" class="metric-value">-</div>
                <div class="metric-label">weeks</div>
              </div>
              <div class="metric">
                <div class="metric-label">Similar Trials</div>
                <div id="similar-trials-value" class="metric-value">-</div>
                <div class="metric-label">analyzed</div>
              </div>
            </div>
            
            <div class="insights-container">
              <h3>Therapeutic Insights</h3>
              
              <div class="insight-section">
                <button class="insight-toggle" data-target="endpoints-content">
                  <span>Common Endpoints</span>
                  <span>+</span>
                </button>
                <div id="endpoints-content" class="insight-content hidden">
                  <ul id="endpoints-list" class="insight-list"></ul>
                </div>
              </div>
              
              <div class="insight-section">
                <button class="insight-toggle" data-target="inclusion-content">
                  <span>Common Inclusion Criteria</span>
                  <span>+</span>
                </button>
                <div id="inclusion-content" class="insight-content hidden">
                  <ul id="inclusion-list" class="insight-list"></ul>
                </div>
              </div>
              
              <div class="insight-section">
                <button class="insight-toggle" data-target="exclusion-content">
                  <span>Common Exclusion Criteria</span>
                  <span>+</span>
                </button>
                <div id="exclusion-content" class="insight-content hidden">
                  <ul id="exclusion-list" class="insight-list"></ul>
                </div>
              </div>
              
              <div class="insight-section">
                <button class="insight-toggle" data-target="challenges-content">
                  <span>Typical Challenges</span>
                  <span>+</span>
                </button>
                <div id="challenges-content" class="insight-content hidden">
                  <ul id="challenges-list" class="insight-list"></ul>
                </div>
              </div>
              
              <div class="insight-section">
                <button class="insight-toggle" data-target="success-factors-content">
                  <span>Success Factors</span>
                  <span>+</span>
                </button>
                <div id="success-factors-content" class="insight-content hidden">
                  <ul id="success-factors-list" class="insight-list"></ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <h2 class="card-title">Response Details</h2>
          <pre id="response-json">No data yet</pre>
        </div>
      </div>
    </div>
  </main>
  
  <footer>
    <div class="container footer-container">
      <div>&copy; 2025 Lumen Biosciences. All rights reserved.</div>
      <div>Strategic Protocol Recommendations Advisor (SPRA) v1.0</div>
    </div>
  </footer>

  <script>
    // DOM Elements
    const form = document.getElementById('protocol-form');
    const resetButton = document.getElementById('reset-button');
    const analyzeButton = document.getElementById('analyze-button');
    const checkApiButton = document.getElementById('check-api-button');
    const loader = document.getElementById('loader');
    const apiStatusContainer = document.getElementById('api-status-container');
    const resultsPlaceholder = document.getElementById('results-placeholder');
    const resultsContent = document.getElementById('results-content');
    const responseJson = document.getElementById('response-json');
    
    // Results Elements
    const gaugeFill = document.getElementById('gauge-fill');
    const successProbabilityValue = document.getElementById('success-probability-value');
    const sampleSizeValue = document.getElementById('sample-size-value');
    const durationValue = document.getElementById('duration-value');
    const similarTrialsValue = document.getElementById('similar-trials-value');
    
    // Insight Lists
    const endpointsList = document.getElementById('endpoints-list');
    const inclusionList = document.getElementById('inclusion-list');
    const exclusionList = document.getElementById('exclusion-list');
    const challengesList = document.getElementById('challenges-list');
    const successFactorsList = document.getElementById('success-factors-list');
    
    // Add event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Check API status on page load
      checkApiStatus();
      
      // Setup insight toggles
      document.querySelectorAll('.insight-toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
          const targetId = toggle.dataset.target;
          const targetEl = document.getElementById(targetId);
          
          if (targetEl.classList.contains('hidden')) {
            targetEl.classList.remove('hidden');
            toggle.querySelector('span:last-child').textContent = '-';
          } else {
            targetEl.classList.add('hidden');
            toggle.querySelector('span:last-child').textContent = '+';
          }
        });
      });
      
      // Form submission
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        analyzeProtocol();
      });
      
      // Reset button
      resetButton.addEventListener('click', resetForm);
      
      // Check API button
      checkApiButton.addEventListener('click', checkApiStatus);
    });
    
    // Function to check API status
    async function checkApiStatus() {
      try {
        const response = await fetch('/api/spra/direct-health');
        
        if (response.ok) {
          const data = await response.json();
          
          apiStatusContainer.innerHTML = `
            <div class="api-status">
              <span class="status-dot active"></span>
              <span class="status-text">API is operational</span>
            </div>
            <div class="status-info">
              <div>Version: ${data.version || '1.0'}</div>
              <div>Last checked: ${new Date().toLocaleTimeString()}</div>
            </div>
          `;
        } else {
          throw new Error(`API returned status: ${response.status}`);
        }
      } catch (error) {
        apiStatusContainer.innerHTML = `
          <div class="api-status">
            <span class="status-dot error"></span>
            <span class="status-text">API error</span>
          </div>
          <div class="status-info">
            <div style="color: var(--danger);">${error.message}</div>
            <div>Last checked: ${new Date().toLocaleTimeString()}</div>
          </div>
        `;
      }
    }
    
    // Function to analyze protocol
    async function analyzeProtocol() {
      // Show loading state
      loader.classList.remove('hidden');
      analyzeButton.disabled = true;
      
      try {
        // Gather form data
        const formData = new FormData(form);
        const requestData = {
          sample_size: parseInt(formData.get('sample_size')),
          duration: parseInt(formData.get('duration')),
          therapeutic_area: formData.get('therapeutic_area'),
          phase: formData.get('phase'),
          randomization: formData.get('randomization'),
          primary_endpoint: formData.get('primary_endpoint')
        };
        
        // Make API request
        const response = await fetch('/api/spra/direct-analyze', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
          throw new Error(`API returned status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Display JSON response
        responseJson.textContent = JSON.stringify(data, null, 2);
        
        // Show results section
        resultsPlaceholder.classList.add('hidden');
        resultsContent.classList.remove('hidden');
        
        // Update metrics
        updateSuccessProbability(data.prediction?.success_probability || 0.5);
        sampleSizeValue.textContent = data.recommendations?.sample_size?.recommended || '-';
        durationValue.textContent = data.recommendations?.duration?.recommended || '-';
        similarTrialsValue.textContent = data.data_sources?.similar_trials_analyzed || '-';
        
        // Update insights
        updateInsightList(endpointsList, data.therapeutic_insights?.common_endpoints || []);
        updateInsightList(inclusionList, data.therapeutic_insights?.common_inclusion_criteria || []);
        updateInsightList(exclusionList, data.therapeutic_insights?.common_exclusion_criteria || []);
        updateInsightList(challengesList, data.therapeutic_insights?.typical_challenges || []);
        updateInsightList(successFactorsList, data.therapeutic_insights?.success_factors || []);
        
      } catch (error) {
        // Handle error
        responseJson.textContent = `Error: ${error.message}`;
        
        // Update API status to show error
        apiStatusContainer.innerHTML = `
          <div class="api-status">
            <span class="status-dot error"></span>
            <span class="status-text">API error</span>
          </div>
          <div class="status-info">
            <div style="color: var(--danger);">${error.message}</div>
            <div>Last checked: ${new Date().toLocaleTimeString()}</div>
          </div>
        `;
      } finally {
        // Reset loading state
        loader.classList.add('hidden');
        analyzeButton.disabled = false;
      }
    }
    
    // Function to reset form
    function resetForm() {
      form.reset();
      document.getElementById('sample-size').value = '250';
      document.getElementById('duration').value = '52';
      document.getElementById('phase').value = 'Phase 2';
      document.getElementById('randomization').value = 'Double-blind';
      document.getElementById('primary-endpoint').value = 'Overall Response Rate';
      
      // Reset results
      resultsPlaceholder.classList.remove('hidden');
      resultsContent.classList.add('hidden');
      responseJson.textContent = 'No data yet';
    }
    
    // Function to update success probability gauge
    function updateSuccessProbability(probability) {
      const percent = Math.round(probability * 100);
      const rotation = probability * 180; // Half circle (180 degrees)
      
      successProbabilityValue.textContent = `${percent}%`;
      gaugeFill.style.transform = `rotate(${rotation}deg)`;
      
      // Set appropriate color based on probability
      let color;
      if (probability < 0.4) {
        color = '#ef4444'; // red
      } else if (probability < 0.6) {
        color = '#f59e0b'; // yellow
      } else {
        color = '#10b981'; // green
      }
      
      gaugeFill.style.backgroundColor = color;
    }
    
    // Function to update insight lists
    function updateInsightList(listElement, items) {
      listElement.innerHTML = '';
      
      if (!items || items.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'No data available';
        listElement.appendChild(li);
        return;
      }
      
      items.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        listElement.appendChild(li);
      });
    }
  </script>
</body>
</html>