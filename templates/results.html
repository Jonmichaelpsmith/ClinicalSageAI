<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results - FAIL MAP</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6">
        <nav class="flex justify-between items-center mb-8 no-print">
            <a href="/" class="text-4xl font-bold text-blue-800">
                Trialsage<span class="text-blue-600">.ai</span>
            </a>
            <div class="flex space-x-4">
                <a href="/" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">
                    Home
                </a>
                <a href="/about" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">
                    About
                </a>
                <button onclick="window.print()" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                    </svg>
                    Print Report
                </button>
            </div>
        </nav>

        <div class="max-w-6xl mx-auto">
            <!-- Report Header -->
            <div class="mb-10 print:mb-6">
                <h1 class="text-4xl font-bold mb-3 text-blue-800">Clinical Trial Protocol Analysis</h1>
                <div class="border-b border-gray-300 pb-2 mb-2">
                    <div class="flex items-center">
                        <div class="mr-2 text-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <p class="text-gray-600">Analysis generated on <span id="current-date"></span></p>
                    </div>
                </div>
            </div>

            <!-- Success Probability Indicator -->
            <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                <div class="flex flex-col md:flex-row items-center">
                    <div class="w-full md:w-1/3 mb-6 md:mb-0 flex flex-col items-center justify-center">
                        <div class="relative">
                            <svg class="w-40 h-40" viewBox="0 0 36 36">
                                <path
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none"
                                    stroke="#eee"
                                    stroke-width="3"
                                />
                                <path id="success-path"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none"
                                    stroke="#4CAF50"
                                    stroke-width="3"
                                    stroke-dasharray="0, 100"
                                />
                                <text id="success-text" x="18" y="20.5" font-family="Arial" font-size="8" text-anchor="middle" fill="#333">
                                    {{ "%.1f"|format(analysis.success_probability * 100) }}%
                                </text>
                            </svg>
                        </div>
                        <p class="mt-3 text-center font-bold text-gray-700">Predicted Success Probability</p>
                    </div>
                    
                    <div class="w-full md:w-2/3 md:pl-8 border-t md:border-t-0 md:border-l border-gray-200 pt-6 md:pt-0 md:pl-8">
                        <h2 class="text-2xl font-bold mb-4 text-blue-700">Study Overview</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-gray-600 mb-1">Therapeutic Area:</p>
                                <p class="font-medium">{{ features.therapeutic_area }}</p>
                            </div>
                            <div>
                                <p class="text-gray-600 mb-1">Indication:</p>
                                <p class="font-medium">{{ features.indication }}</p>
                            </div>
                            <div>
                                <p class="text-gray-600 mb-1">Phase:</p>
                                <p class="font-medium">Phase {{ features.phase }}</p>
                            </div>
                            <div>
                                <p class="text-gray-600 mb-1">Sample Size:</p>
                                <p class="font-medium">{{ features.sample_size }} participants</p>
                            </div>
                            <div>
                                <p class="text-gray-600 mb-1">Randomization:</p>
                                <p class="font-medium">{{ features.randomization }}</p>
                            </div>
                            <div>
                                <p class="text-gray-600 mb-1">Blinding:</p>
                                <p class="font-medium">{{ features.blinding }}</p>
                            </div>
                            <div>
                                <p class="text-gray-600 mb-1">Primary Endpoint:</p>
                                <p class="font-medium">{{ features.primary_endpoint }}</p>
                            </div>
                            <div>
                                <p class="text-gray-600 mb-1">Region:</p>
                                <p class="font-medium">{{ features.region }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Risk Factors and Recommendations -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <!-- Risk Factors -->
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <div class="flex items-center mb-4">
                        <div class="text-red-500 mr-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-red-600">Risk Factors</h2>
                    </div>
                    
                    <ul class="space-y-4">
                        {% if analysis.risk_factors %}
                            {% for risk in analysis.risk_factors %}
                                <li class="flex">
                                    <div class="text-red-500 mt-1 mr-3 flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <p class="text-gray-700">{{ risk }}</p>
                                </li>
                            {% endfor %}
                        {% else %}
                            <li class="text-gray-700">No significant risk factors identified.</li>
                        {% endif %}
                    </ul>
                </div>
                
                <!-- Recommendations -->
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <div class="flex items-center mb-4">
                        <div class="text-green-500 mr-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-green-600">Recommendations</h2>
                    </div>
                    
                    <ul class="space-y-4">
                        {% if analysis.recommendations %}
                            {% for rec in analysis.recommendations %}
                                <li class="flex">
                                    <div class="text-green-500 mt-1 mr-3 flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <p class="text-gray-700">{{ rec }}</p>
                                </li>
                            {% endfor %}
                        {% else %}
                            <li class="text-gray-700">No specific recommendations needed. Your protocol design appears optimized.</li>
                        {% endif %}
                    </ul>
                </div>
            </div>

            <!-- Similar Studies Overview -->
            <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                <h2 class="text-2xl font-bold mb-6 text-blue-700">Similar Historical Studies</h2>
                <p class="text-gray-600 mb-4">
                    We analyzed {{ analysis.similar_studies|length }} similar studies in our database to identify patterns and factors that influence success probability.
                </p>
                
                <div class="responsive-table">
                    <table class="min-w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-3 px-4 text-left text-gray-700 font-medium">Therapeutic Area</th>
                                <th class="py-3 px-4 text-left text-gray-700 font-medium">Indication</th>
                                <th class="py-3 px-4 text-left text-gray-700 font-medium">Phase</th>
                                <th class="py-3 px-4 text-left text-gray-700 font-medium">Sample Size</th>
                                <th class="py-3 px-4 text-left text-gray-700 font-medium">Randomization</th>
                                <th class="py-3 px-4 text-left text-gray-700 font-medium">Blinding</th>
                                <th class="py-3 px-4 text-left text-gray-700 font-medium">Outcome</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for study in analysis.similar_studies %}
                                <tr class="hover:bg-gray-50 border-t border-gray-200">
                                    <td class="py-3 px-4 text-gray-700">{{ study.therapeutic_area }}</td>
                                    <td class="py-3 px-4 text-gray-700">{{ study.indication }}</td>
                                    <td class="py-3 px-4 text-gray-700">{{ study.phase }}</td>
                                    <td class="py-3 px-4 text-gray-700">{{ study.sample_size }}</td>
                                    <td class="py-3 px-4 text-gray-700">{{ study.randomization }}</td>
                                    <td class="py-3 px-4 text-gray-700">{{ study.blinding }}</td>
                                    <td class="py-3 px-4">
                                        {% if study.success == 1 %}
                                            <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">Success</span>
                                        {% else %}
                                            <span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">Failure</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Visualizations Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <!-- Success Rate by Phase -->
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h3 class="text-xl font-bold mb-4 text-blue-700">Success Rate by Phase</h3>
                    <div id="phase-chart" class="h-64"></div>
                </div>
                
                <!-- Success Rate by Therapeutic Area -->
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h3 class="text-xl font-bold mb-4 text-blue-700">Success Rate by Therapeutic Area</h3>
                    <div id="ta-chart" class="h-64"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <!-- Sample Size Distribution -->
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h3 class="text-xl font-bold mb-4 text-blue-700">Sample Size Distribution</h3>
                    <div id="sample-size-chart" class="h-64"></div>
                </div>
                
                <!-- Success Rate by Blinding -->
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h3 class="text-xl font-bold mb-4 text-blue-700">Success Rate by Blinding</h3>
                    <div id="blinding-chart" class="h-64"></div>
                </div>
            </div>

            <!-- Summary and Next Steps -->
            <div class="bg-blue-50 rounded-xl p-8 mb-12">
                <h2 class="text-2xl font-bold mb-4 text-blue-700">Summary & Next Steps</h2>
                <div class="prose max-w-none text-gray-700">
                    <p>
                        Based on our analysis of your clinical trial protocol for {{ features.indication }} ({{ features.therapeutic_area }}), 
                        we predict a {{ "%.1f"|format(analysis.success_probability * 100) }}% probability of success. 
                        {% if analysis.success_probability >= 0.7 %}
                            This is a promising outlook compared to industry standards.
                        {% elif analysis.success_probability >= 0.5 %}
                            This represents a moderate probability of success with room for optimization.
                        {% else %}
                            This indicates significant risks that should be addressed before proceeding.
                        {% endif %}
                    </p>
                    
                    <p class="mt-4">
                        We recommend the following next steps:
                    </p>
                    
                    <ol class="list-decimal pl-5 mt-2 space-y-2">
                        {% if analysis.recommendations %}
                            <li>Review and implement the specific recommendations outlined in this report.</li>
                        {% else %}
                            <li>Your protocol design appears solid, but consider peer review before submission.</li>
                        {% endif %}
                        <li>Conduct a detailed power analysis to ensure adequate statistical power.</li>
                        <li>Review similar studies in your therapeutic area for additional insights.</li>
                        <li>Consider consulting with specialized clinical trial design experts in {{ features.therapeutic_area }}.</li>
                    </ol>
                </div>
            </div>

            <!-- Footer -->
            <div class="text-center text-gray-500 text-sm print:mt-12 no-print">
                <p>© 2025 Trialsage.ai - Global Intelligence System for Clinical Study Reports</p>
                <p class="mt-1">Analysis based on 3,000 clinical studies with advanced AI interpretation</p>
            </div>
        </div>
    </div>

    <script>
        // Set current date
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Animate success probability indicator
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const successPath = document.getElementById('success-path');
                const successProb = {{ analysis.success_probability }};
                const dashValue = successProb * 100;
                successPath.style.strokeDasharray = dashValue + ", 100";
                
                // Set color based on success probability
                if (successProb >= 0.7) {
                    successPath.style.stroke = "#4CAF50"; // Green for high probability
                } else if (successProb >= 0.5) {
                    successPath.style.stroke = "#FF9800"; // Orange for medium probability
                } else {
                    successPath.style.stroke = "#F44336"; // Red for low probability
                }
            }, 300);
        });

        // Extract data from similar studies for charts
        const similarStudies = JSON.parse('{{ analysis.similar_studies|tojson }}');
        
        // Success rate by phase chart
        function createPhaseChart() {
            const phaseData = {
                'I': { total: 0, success: 0 },
                'II': { total: 0, success: 0 },
                'III': { total: 0, success: 0 },
                'IV': { total: 0, success: 0 }
            };
            
            similarStudies.forEach(study => {
                if (phaseData[study.phase]) {
                    phaseData[study.phase].total++;
                    if (study.success === 1) {
                        phaseData[study.phase].success++;
                    }
                }
            });
            
            const phases = Object.keys(phaseData);
            const rates = phases.map(phase => {
                return phaseData[phase].total > 0 
                    ? (phaseData[phase].success / phaseData[phase].total * 100).toFixed(1)
                    : 0;
            });

            Plotly.newPlot('phase-chart', [{
                x: phases,
                y: rates,
                type: 'bar',
                marker: {
                    color: '#3182CE'
                }
            }], {
                margin: { t: 20, r: 20, b: 40, l: 40 },
                yaxis: {
                    title: 'Success Rate (%)',
                    range: [0, 100]
                }
            });
        }
        
        // Success rate by therapeutic area chart
        function createTAChart() {
            const taData = {};
            
            similarStudies.forEach(study => {
                if (!taData[study.therapeutic_area]) {
                    taData[study.therapeutic_area] = { total: 0, success: 0 };
                }
                
                taData[study.therapeutic_area].total++;
                if (study.success === 1) {
                    taData[study.therapeutic_area].success++;
                }
            });
            
            const tas = Object.keys(taData);
            const rates = tas.map(ta => {
                return taData[ta].total > 0 
                    ? (taData[ta].success / taData[ta].total * 100).toFixed(1)
                    : 0;
            });

            Plotly.newPlot('ta-chart', [{
                x: tas,
                y: rates,
                type: 'bar',
                marker: {
                    color: '#4C51BF'
                }
            }], {
                margin: { t: 20, r: 20, b: 60, l: 40 },
                yaxis: {
                    title: 'Success Rate (%)',
                    range: [0, 100]
                },
                xaxis: {
                    tickangle: -45
                }
            });
        }
        
        // Sample size distribution chart
        function createSampleSizeChart() {
            // Group sample sizes into ranges
            const sampleSizeGroups = {
                '<50': { total: 0, success: 0 },
                '50-100': { total: 0, success: 0 },
                '101-300': { total: 0, success: 0 },
                '301-500': { total: 0, success: 0 },
                '501-1000': { total: 0, success: 0 },
                '>1000': { total: 0, success: 0 }
            };
            
            similarStudies.forEach(study => {
                let group;
                const size = study.sample_size;
                
                if (size < 50) group = '<50';
                else if (size <= 100) group = '50-100';
                else if (size <= 300) group = '101-300';
                else if (size <= 500) group = '301-500';
                else if (size <= 1000) group = '501-1000';
                else group = '>1000';
                
                sampleSizeGroups[group].total++;
                if (study.success === 1) {
                    sampleSizeGroups[group].success++;
                }
            });
            
            const groups = Object.keys(sampleSizeGroups);
            const rates = groups.map(group => {
                return sampleSizeGroups[group].total > 0 
                    ? (sampleSizeGroups[group].success / sampleSizeGroups[group].total * 100).toFixed(1)
                    : 0;
            });

            Plotly.newPlot('sample-size-chart', [{
                x: groups,
                y: rates,
                type: 'bar',
                marker: {
                    color: '#38A169'
                }
            }], {
                margin: { t: 20, r: 20, b: 40, l: 40 },
                yaxis: {
                    title: 'Success Rate (%)',
                    range: [0, 100]
                }
            });
        }
        
        // Success rate by blinding chart
        function createBlindingChart() {
            const blindingData = {
                'Double-blind': { total: 0, success: 0 },
                'Single-blind': { total: 0, success: 0 },
                'Open-label': { total: 0, success: 0 }
            };
            
            similarStudies.forEach(study => {
                if (blindingData[study.blinding]) {
                    blindingData[study.blinding].total++;
                    if (study.success === 1) {
                        blindingData[study.blinding].success++;
                    }
                }
            });
            
            const blindings = Object.keys(blindingData);
            const rates = blindings.map(blinding => {
                return blindingData[blinding].total > 0 
                    ? (blindingData[blinding].success / blindingData[blinding].total * 100).toFixed(1)
                    : 0;
            });

            Plotly.newPlot('blinding-chart', [{
                x: blindings,
                y: rates,
                type: 'bar',
                marker: {
                    color: '#805AD5'
                }
            }], {
                margin: { t: 20, r: 20, b: 40, l: 40 },
                yaxis: {
                    title: 'Success Rate (%)',
                    range: [0, 100]
                }
            });
        }
        
        // Create all charts when document is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                createPhaseChart();
                createTAChart();
                createSampleSizeChart();
                createBlindingChart();
            }, 500);
            
            // Redraw charts when window is resized
            window.addEventListener('resize', function() {
                createPhaseChart();
                createTAChart();
                createSampleSizeChart();
                createBlindingChart();
            });
        });
    </script>
</body>
</html>