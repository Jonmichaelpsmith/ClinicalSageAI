<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMA API Dashboard - Trialsage.ai</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6">
        <nav class="flex justify-between items-center mb-8">
            <a href="/" class="text-4xl font-bold text-blue-800">
                Trialsage<span class="text-blue-600">.ai</span>
            </a>
            <div class="flex space-x-4">
                <a href="/" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">
                    Home
                </a>
                <a href="/about" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">
                    About
                </a>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                <h1 class="text-3xl font-bold mb-6 text-blue-800">EMA API Integration Dashboard</h1>
                
                <div class="bg-blue-50 rounded-lg p-4 mb-6 border border-blue-200">
                    <h2 class="text-xl font-semibold text-blue-700 mb-2">Current Status</h2>
                    <div id="status-container" class="animate-pulse">
                        <p class="text-gray-500">Loading status...</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Download Progress Card -->
                    <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Download Progress</h3>
                        <div id="download-progress">
                            <div class="mb-2 flex justify-between">
                                <span class="text-gray-700">Downloaded CSRs</span>
                                <span id="downloaded-count" class="font-medium">0</span>
                            </div>
                            <div class="mb-2 flex justify-between">
                                <span class="text-gray-700">Total CSRs Found</span>
                                <span id="total-found" class="font-medium">0</span>
                            </div>
                            <div class="mb-4 flex justify-between">
                                <span class="text-gray-700">Failed Downloads</span>
                                <span id="failed-count" class="font-medium text-red-600">0</span>
                            </div>
                            
                            <div class="relative pt-1 mb-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span id="progress-percentage" class="text-xs font-semibold inline-block text-blue-600">
                                            0%
                                        </span>
                                    </div>
                                    <div class="text-right">
                                        <span id="progress-eta" class="text-xs font-semibold inline-block text-gray-600">
                                            ETA: -
                                        </span>
                                    </div>
                                </div>
                                <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-200">
                                    <div id="progress-bar" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div class="flex flex-wrap gap-2">
                                <button id="start-download-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                    Start Download
                                </button>
                                <button id="retry-download-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                                    Retry Failed
                                </button>
                                <button id="process-csrs-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                                    Process for Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Download Settings Card -->
                    <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Download Settings</h3>
                        <form id="download-settings-form" class="space-y-4">
                            <div>
                                <label for="therapeutic-area" class="block text-sm font-medium text-gray-700 mb-1">
                                    Therapeutic Area (Optional)
                                </label>
                                <input 
                                    type="text" 
                                    id="therapeutic-area" 
                                    class="w-full p-2 border border-gray-300 rounded-md" 
                                    placeholder="e.g. Oncology, Cardiology"
                                >
                            </div>
                            
                            <div>
                                <label for="limit" class="block text-sm font-medium text-gray-700 mb-1">
                                    Limit (Optional)
                                </label>
                                <input 
                                    type="number" 
                                    id="limit" 
                                    class="w-full p-2 border border-gray-300 rounded-md" 
                                    placeholder="Number of CSRs to download"
                                >
                                <p class="text-xs text-gray-500 mt-1">Leave empty to download all available CSRs</p>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="batch-size" class="block text-sm font-medium text-gray-700 mb-1">
                                        Batch Size
                                    </label>
                                    <input 
                                        type="number" 
                                        id="batch-size" 
                                        class="w-full p-2 border border-gray-300 rounded-md" 
                                        value="50"
                                        min="10"
                                        max="100"
                                    >
                                </div>
                                
                                <div>
                                    <label for="max-workers" class="block text-sm font-medium text-gray-700 mb-1">
                                        Max Workers
                                    </label>
                                    <input 
                                        type="number" 
                                        id="max-workers" 
                                        class="w-full p-2 border border-gray-300 rounded-md" 
                                        value="5"
                                        min="1"
                                        max="10"
                                    >
                                </div>
                            </div>
                            
                            <div class="pt-2">
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                                    Apply Settings & Start Download
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Search and Results Section -->
                <div class="space-y-6">
                    <h2 class="text-xl font-semibold text-blue-700">Search CSR Reports</h2>
                    
                    <div class="flex flex-wrap gap-4 mb-6">
                        <div class="flex-1 min-w-[240px]">
                            <input 
                                type="text" 
                                id="search-therapeutic-area" 
                                class="w-full p-2 border border-gray-300 rounded-md" 
                                placeholder="Therapeutic Area"
                            >
                        </div>
                        <div class="flex-1 min-w-[240px]">
                            <input 
                                type="text" 
                                id="search-scientific-name" 
                                class="w-full p-2 border border-gray-300 rounded-md" 
                                placeholder="Scientific Name / Indication"
                            >
                        </div>
                        <div class="flex-1 min-w-[240px]">
                            <input 
                                type="text" 
                                id="search-procedure-number" 
                                class="w-full p-2 border border-gray-300 rounded-md" 
                                placeholder="Procedure Number"
                            >
                        </div>
                        <div>
                            <button id="search-btn" class="h-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                Search
                            </button>
                        </div>
                    </div>
                    
                    <div id="search-results" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead>
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left">Report ID</th>
                                        <th class="py-2 px-4 border-b text-left">Title</th>
                                        <th class="py-2 px-4 border-b text-left">Scientific Name</th>
                                        <th class="py-2 px-4 border-b text-left">Therapeutic Area</th>
                                        <th class="py-2 px-4 border-b text-left">Publication Date</th>
                                        <th class="py-2 px-4 border-b text-left">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="search-results-body">
                                    <!-- Results will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="flex justify-between items-center mt-4">
                            <div>
                                <span id="results-count">0</span> results found
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="prev-page" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded disabled:opacity-50">
                                    Previous
                                </button>
                                <span id="page-info">Page 1 of 1</span>
                                <button id="next-page" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded disabled:opacity-50">
                                    Next
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="no-results" class="hidden py-8 text-center">
                        <p class="text-gray-500">No results found matching your search criteria.</p>
                    </div>
                </div>
            </div>
            
            <!-- Status Messages and Logs -->
            <div class="bg-white rounded-xl shadow-lg p-8 mb-12">
                <h2 class="text-xl font-semibold text-blue-700 mb-4">Status Log</h2>
                <div id="status-log" class="bg-gray-100 rounded-lg p-4 h-64 overflow-y-auto font-mono text-sm">
                    <div class="text-gray-500">Status log will appear here...</div>
                </div>
            </div>
        </div>
        
        <footer class="text-center text-gray-500 text-sm mt-20">
            <p>Â© 2025 Trialsage.ai - Global Intelligence System for Clinical Study Reports</p>
            <p class="mt-1">Powered by EMA API integration</p>
        </footer>
    </div>
    
    <!-- JavaScript for the dashboard functionality -->
    <script>
        // State variables
        let currentPage = 1;
        let totalPages = 1;
        let searchParams = {};
        let statusRefreshInterval;
        
        // DOM elements
        const statusContainer = document.getElementById('status-container');
        const downloadedCount = document.getElementById('downloaded-count');
        const totalFound = document.getElementById('total-found');
        const failedCount = document.getElementById('failed-count');
        const progressBar = document.getElementById('progress-bar');
        const progressPercentage = document.getElementById('progress-percentage');
        const progressEta = document.getElementById('progress-eta');
        const startDownloadBtn = document.getElementById('start-download-btn');
        const retryDownloadBtn = document.getElementById('retry-download-btn');
        const processCSRsBtn = document.getElementById('process-csrs-btn');
        const downloadSettingsForm = document.getElementById('download-settings-form');
        const searchBtn = document.getElementById('search-btn');
        const searchResultsSection = document.getElementById('search-results');
        const searchResultsBody = document.getElementById('search-results-body');
        const noResultsSection = document.getElementById('no-results');
        const resultsCount = document.getElementById('results-count');
        const pageInfo = document.getElementById('page-info');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const statusLog = document.getElementById('status-log');
        
        // Helper functions
        function logStatus(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type === 'error' ? 'text-red-600' : (type === 'success' ? 'text-green-600' : 'text-gray-700');
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            statusLog.appendChild(logEntry);
            statusLog.scrollTop = statusLog.scrollHeight;
        }
        
        function updateStatusFromApi() {
            axios.get('/ema/status')
                .then(response => {
                    const data = response.data;
                    
                    // Update download progress
                    downloadedCount.textContent = data.download_progress.downloaded;
                    totalFound.textContent = data.download_progress.total_found;
                    failedCount.textContent = data.download_progress.failed;
                    
                    // Update progress bar
                    const percent = data.download_progress.progress_percentage.toFixed(1);
                    progressBar.style.width = `${percent}%`;
                    progressPercentage.textContent = `${percent}%`;
                    progressEta.textContent = `ETA: ${data.download_progress.estimated_time_remaining}`;
                    
                    // Update status container
                    let statusHtml = `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <p class="text-sm text-gray-500">API Status</p>
                                <p class="font-medium ${data.api_status === 'connected' ? 'text-green-600' : 'text-red-600'}">
                                    ${data.api_status}
                                </p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Background Task</p>
                                <p class="font-medium ${data.background_task.running ? 'text-blue-600' : 'text-gray-600'}">
                                    ${data.background_task.running ? data.background_task.task_type + ' (running)' : 'Idle'}
                                </p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Downloaded CSRs</p>
                                <p class="font-medium text-blue-600">
                                    ${data.database.downloaded_csrs} / ${data.database.total_records}
                                </p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Progress</p>
                                <p class="font-medium">
                                    ${data.background_task.running ? data.background_task.progress.toFixed(1) + '%' : 'N/A'}
                                </p>
                            </div>
                        </div>
                    `;
                    
                    if (data.background_task.running) {
                        statusHtml += `
                            <div class="mt-4 p-3 bg-blue-100 text-blue-800 rounded-lg">
                                ${data.background_task.status_message}
                            </div>
                        `;
                    } else if (data.background_task.error) {
                        statusHtml += `
                            <div class="mt-4 p-3 bg-red-100 text-red-800 rounded-lg">
                                Error: ${data.background_task.error}
                            </div>
                        `;
                    }
                    
                    statusContainer.innerHTML = statusHtml;
                    statusContainer.classList.remove('animate-pulse');
                    
                    // Update button states based on task status
                    startDownloadBtn.disabled = data.background_task.running;
                    retryDownloadBtn.disabled = data.background_task.running;
                    processCSRsBtn.disabled = data.background_task.running;
                    
                    startDownloadBtn.classList.toggle('opacity-50', data.background_task.running);
                    retryDownloadBtn.classList.toggle('opacity-50', data.background_task.running);
                    processCSRsBtn.classList.toggle('opacity-50', data.background_task.running);
                    
                    // Log background task status
                    if (data.background_task.running && data.background_task.status_message) {
                        logStatus(data.background_task.status_message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    statusContainer.innerHTML = `
                        <div class="p-3 bg-red-100 text-red-800 rounded-lg">
                            Error fetching status from server.
                        </div>
                    `;
                    statusContainer.classList.remove('animate-pulse');
                    logStatus('Error fetching status from server: ' + error.message, 'error');
                });
        }
        
        function startDownload(settings = {}) {
            axios.post('/ema/download', settings)
                .then(response => {
                    logStatus(`Download started: ${JSON.stringify(response.data)}`, 'success');
                    updateStatusFromApi();
                })
                .catch(error => {
                    console.error('Error starting download:', error);
                    logStatus('Error starting download: ' + error.message, 'error');
                });
        }
        
        function retryDownload() {
            axios.post('/ema/retry')
                .then(response => {
                    logStatus(`Retry started: ${JSON.stringify(response.data)}`, 'success');
                    updateStatusFromApi();
                })
                .catch(error => {
                    console.error('Error retrying failed downloads:', error);
                    logStatus('Error retrying failed downloads: ' + error.message, 'error');
                });
        }
        
        function processCSRs() {
            axios.post('/ema/process')
                .then(response => {
                    logStatus(`Processing result: ${JSON.stringify(response.data)}`, 'success');
                })
                .catch(error => {
                    console.error('Error processing CSRs:', error);
                    logStatus('Error processing CSRs: ' + error.message, 'error');
                });
        }
        
        function searchCSRs() {
            const therapeuticArea = document.getElementById('search-therapeutic-area').value;
            const scientificName = document.getElementById('search-scientific-name').value;
            const procedureNumber = document.getElementById('search-procedure-number').value;
            
            searchParams = {
                therapeutic_area: therapeuticArea,
                scientific_name: scientificName,
                procedure_number: procedureNumber,
                page: currentPage,
                page_size: 10
            };
            
            logStatus(`Searching for CSRs with: ${JSON.stringify(searchParams)}`);
            
            axios.get('/ema/search', { params: searchParams })
                .then(response => {
                    const data = response.data;
                    
                    if (data.items && data.items.length > 0) {
                        displaySearchResults(data);
                        searchResultsSection.classList.remove('hidden');
                        noResultsSection.classList.add('hidden');
                    } else {
                        searchResultsSection.classList.add('hidden');
                        noResultsSection.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error searching CSRs:', error);
                    logStatus('Error searching CSRs: ' + error.message, 'error');
                });
        }
        
        function displaySearchResults(data) {
            // Update pagination info
            totalPages = Math.ceil(data.totalItems / searchParams.page_size);
            resultsCount.textContent = data.totalItems;
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            
            // Update pagination buttons
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
            
            // Clear previous results
            searchResultsBody.innerHTML = '';
            
            // Add new results
            data.items.forEach(report => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2 px-4 border-b">${report.id}</td>
                    <td class="py-2 px-4 border-b">${report.title || 'N/A'}</td>
                    <td class="py-2 px-4 border-b">${report.scientificName || 'N/A'}</td>
                    <td class="py-2 px-4 border-b">${report.therapeuticArea || 'N/A'}</td>
                    <td class="py-2 px-4 border-b">${report.publicationDate || 'N/A'}</td>
                    <td class="py-2 px-4 border-b">
                        <button class="download-single-btn px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700" 
                                data-id="${report.id}">
                            Download
                        </button>
                    </td>
                `;
                searchResultsBody.appendChild(row);
            });
            
            // Add click handlers for download buttons
            document.querySelectorAll('.download-single-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const reportId = btn.getAttribute('data-id');
                    downloadSingleReport(reportId);
                });
            });
        }
        
        function downloadSingleReport(reportId) {
            logStatus(`Downloading single report: ${reportId}`);
            
            // Here we'd use the existing client download function
            // For this demo, we'll just simulate it
            btn.textContent = 'Downloading...';
            
            setTimeout(() => {
                logStatus(`Downloaded report ${reportId}`, 'success');
                btn.textContent = 'Downloaded';
                updateStatusFromApi();
            }, 2000);
        }
        
        // Event listeners
        startDownloadBtn.addEventListener('click', () => startDownload());
        
        retryDownloadBtn.addEventListener('click', retryDownload);
        
        processCSRsBtn.addEventListener('click', processCSRs);
        
        downloadSettingsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const settings = {
                therapeutic_area: document.getElementById('therapeutic-area').value,
                limit: document.getElementById('limit').value ? parseInt(document.getElementById('limit').value) : null,
                batch_size: parseInt(document.getElementById('batch-size').value),
                max_workers: parseInt(document.getElementById('max-workers').value)
            };
            
            startDownload(settings);
        });
        
        searchBtn.addEventListener('click', searchCSRs);
        
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                searchCSRs();
            }
        });
        
        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                searchCSRs();
            }
        });
        
        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            updateStatusFromApi();
            statusRefreshInterval = setInterval(updateStatusFromApi, 5000); // Update every 5 seconds
            
            logStatus('Dashboard initialized');
        });
        
        // Cleanup when leaving the page
        window.addEventListener('beforeunload', () => {
            clearInterval(statusRefreshInterval);
        });
    </script>
</body>
</html>