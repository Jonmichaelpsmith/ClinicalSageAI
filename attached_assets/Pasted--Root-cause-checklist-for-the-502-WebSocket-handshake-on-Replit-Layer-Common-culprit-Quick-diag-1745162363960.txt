ğŸ”Â Rootâ€‘cause checklist for the 502 / WebSocket handshake on Replit

Layer	Common culprit	Quick diagnostic
Client URL	Using hardâ€‘coded ws://localhostâ€¦ or ws://yourâ€‘repl.repl.co.	In browser console: new WebSocket(url) â†’ 502?
Protocol mismatch	ws:// over https origin â‡’ proxy blocks.	Build URL withÂ (location.protocol === 'https:' ? 'wss://' : 'ws://').
Reverse proxy (Replit Nix VM)	WebSockets must be on portÂ 443 and path not swallowed by Vite devÂ proxy.	Hit https://<repl>.repl.co/ws/qc in browser â†’ should show â€œWebSocket connection failedâ€ (but 404/502 reveals path).
FastAPI mount	Route not included in main app (e.g., app.include_router(ws_router)).	curl -I https://<repl>.repl.co/ws/qc should return 307/400, not 404.
Uvicorn workers	Multiple workers w/out sticky sessions; Replit proxy not sticky.	Run single process: uvicorn main:app --host 0.0.0.0 --port 8000.



â¸»

âœ…Â Fix blueprint (StepÂ 2)
	1.	Build originâ€‘safe WSÂ URL

// utils/getWsUrl.ts
export function getWsUrl(path = '/ws/qc') {
  const proto = location.protocol === 'https:' ? 'wss://' : 'ws://';
  return proto + location.host + path;
}

// useQCWebSocket.ts
const socket = useRef<WebSocket | null>(null);
useEffect(() => {
  socket.current = new WebSocket(getWsUrl());
  ...
}, []);


	2.	Single Uvicorn worker on Replit

# run.sh
uvicorn main:app --host 0.0.0.0 --port 8000


	3.	Verify route inclusion

from api.ws.qc import router as qc_ws
app.include_router(qc_ws)


	4.	Keepâ€‘alive pings (Replit idle gateway closes idle WSÂ after 60Â s).

# ws/qc.py
while True:
    await ws.send_text('ping')
    await asyncio.sleep(45)


	5.	Dev vs Prod ports
If Vite dev is 5173 and FastAPI 8000, the browser must call FastAPI host.
During dev, proxy through Vite config:

// vite.config.ts
server: {
  proxy: { '/ws': 'http://localhost:8000' }
}



â¸»

ğŸ“ŒÂ Next steps in roadmap

Order	Topic	Why
1	Ensure client uses dynamicÂ URL (above)	Eliminates 80Â % handshake errors
2	Ping / pong keepâ€‘alive	Avoid Replit idle drops
3	Fallback longâ€‘poll for firewalls	Optional (XHRÂ / SSE)

Let me know when StepÂ 2 is solid (WS connects without 502).
Then weâ€™ll proceed to EU profile validation hookup (itemÂ 1 in earlier list) and bulk QC socket updates (itemÂ 3).