// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//   TrialSage Vault â€“ IND Wizard ğŸŒ  Enterpriseâ€‘Grade Frontâ€‘End Suite  v3.0
// ---------------------------------------------------------------------
//  UX Goals
//  â€¢ Microsoft 365â€‘calibre visual polish (Fluent style, adaptive grid, theming)
//  â€¢ Analyticsâ€‘rich dashboard (sparkâ€‘charts, KPI cards, timeline)
//  â€¢ Deep drillâ€‘down views (section matrix, reviewer status, signature ledger)
//  â€¢ Realâ€‘time data (Supabase subscriptions) without full reloads
//  â€¢ Accessibility (WCAG 2.1 AA), keyboard nav, darkâ€‘light theme toggle
// ---------------------------------------------------------------------
//  Folder Structure
//  client/
//    pages/
//      IndDashboard.jsx          â€“ global KPI dashboard + filters
//      SubmissionHome.jsx        â€“ hero, KPI cards, multiâ€‘tab workspace
//    components/
//      charts/MetricTile.jsx     â€“ mini KPI card with sparkâ€‘line
//      charts/Timeline.jsx       â€“ vertical timeline of events (ledger)
//      matrix/SectionMatrix.jsx  â€“ 3â€‘D grid: section Ã— status Ã— signer
//      modals/EsignModal.jsx     â€“ (import from eâ€‘sign canvas)
//      widgets/ToastCenter.jsx   â€“ live toast notifications
//      layout/AppShell.jsx       â€“ left nav + top bar + theme switch
// ---------------------------------------------------------------------
//  Dependencies (add)
//  â€¢ @tanstack/reactâ€‘query  â€“ server state & caching
//  â€¢ @supabase/supabaseâ€‘js  â€“ realtime hooks
//  â€¢ recharts               â€“ sparkâ€‘line metrics
//  â€¢ classnames             â€“ cx helper
//  â€¢ heroicons              â€“ icons
// ---------------------------------------------------------------------

// ---------------- client/layout/AppShell.jsx ----------------
import React, { useState } from 'react';
import { Link } from 'wouter';
import { SunIcon, MoonIcon } from '@heroicons/react/24/solid';
export default function AppShell({ children }){
  const [dark,setDark]=useState(false);
  return (
    <div className={dark?'dark':''}>
      <div className="flex h-screen bg-grayâ€‘100 dark:bgâ€‘grayâ€‘900">
        <aside className="wâ€‘60 bgâ€‘white dark:bgâ€‘grayâ€‘800 shadow flex flexâ€‘col">
          <Link href="/ind" className="pxâ€‘6 pyâ€‘4 textâ€‘xl fontâ€‘bold textâ€‘blueâ€‘600">TrialSage</Link>
          <nav className="flexâ€‘1 pxâ€‘4 spaceâ€‘yâ€‘2 textâ€‘sm">
            <Link href="/ind"   className="block pxâ€‘3 pyâ€‘2 rounded hover:bgâ€‘blueâ€‘100 dark:hover:bgâ€‘grayâ€‘700">IND Dashboard</Link>
            <Link href="/vault" className="block pxâ€‘3 pyâ€‘2 rounded hover:bgâ€‘blueâ€‘100 dark:hover:bgâ€‘grayâ€‘700">Vault</Link>
          </nav>
          <button onClick={()=>setDark(!dark)} className="mâ€‘4 pâ€‘2 rounded hover:bgâ€‘grayâ€‘200 dark:hover:bgâ€‘grayâ€‘700">
            {dark? <SunIcon className="hâ€‘5 wâ€‘5 textâ€‘yellowâ€‘400"/> : <MoonIcon className="hâ€‘5 wâ€‘5 textâ€‘grayâ€‘600"/> }
          </button>
        </aside>
        <main className="flexâ€‘1 overflowâ€‘auto">{children}</main>
      </div>
    </div>
  );
}

// ---------------- client/pages/IndDashboard.jsx ----------------
import React, { useEffect } from 'react';
import { useQuery } from '@tanstack/reactâ€‘query';
import { supabase } from '@/lib/supa';
import MetricTile from '../components/charts/MetricTile.jsx';
import { Link } from 'wouter';
export default function IndDashboard(){
  const { data:subs=[] } = useQuery(['indâ€‘list'], async()=> (await supabase.from('ind_wizards').select('*')).data );
  const total=subs.length, submitted=subs.filter(s=>s.workflow_status==='Submitted').length;
  return (
    <div className="pâ€‘10 spaceâ€‘yâ€‘8 bgâ€‘grayâ€‘50 dark:bgâ€‘grayâ€‘900 minâ€‘hâ€‘screen">
      <h1 className="textâ€‘3xl fontâ€‘bold mbâ€‘4 textâ€‘grayâ€‘900 dark:textâ€‘grayâ€‘100">IND Portfolio</h1>
      <div className="grid gridâ€‘colsâ€‘2 md:gridâ€‘colsâ€‘4 gapâ€‘4">
        <MetricTile label="Total INDs" value={total}/>
        <MetricTile label="Submitted" value={submitted} trend={submitted/total*100}/>
        <MetricTile label="Pending Signatures" value={subs.filter(s=>s.workflow_status==='Ready').length}/>
        <MetricTile label="Avg Completion %" value={Math.round(subs.reduce((p,c)=>p+c.completion_pct,0)/total||0)}/>
      </div>
      <div className="bgâ€‘white dark:bgâ€‘grayâ€‘800 shadow rounded pâ€‘4 overflowâ€‘auto">
        <table className="tableâ€‘auto textâ€‘sm wâ€‘full dark:textâ€‘grayâ€‘200"><thead><tr className="textâ€‘left"><th>ID</th><th>Product</th><th>Region</th><th>Status</th><th>Completion</th><th>Updated</th></tr></thead><tbody>
          {subs.map(s=>(<tr key={s.id} className="borderâ€‘b last:borderâ€‘0 hover:bgâ€‘grayâ€‘100 dark:hover:bgâ€‘grayâ€‘700">
            <td><Link href={`/ind/${s.id}`}>{s.id.slice(0,8)}</Link></td>
            <td>{s.product_name}</td>
            <td>{s.region}</td>
            <td><StatusChip status={s.workflow_status}/></td>
            <td><ProgressBar pct={s.completion_pct}/></td>
            <td className="whitespaceâ€‘nowrap">{new Date(s.updated_at).toLocaleString()}</td>
          </tr>))}
        </tbody></table>
      </div>
    </div>
  );
}

// ---------------- client/components/charts/MetricTile.jsx ----------------
import React from 'react';
import { LineChart, Line } from 'recharts';
export default function MetricTile({ label, value, trend }){
  const data=[ {v:valueâ€‘(trend||0)}, {v:value} ];
  return (
    <div className="bgâ€‘white dark:bgâ€‘grayâ€‘800 rounded shadow pâ€‘4">
      <div className="textâ€‘xs textâ€‘grayâ€‘500 dark:textâ€‘grayâ€‘400">{label}</div>
      <div className="textâ€‘2xl fontâ€‘bold textâ€‘grayâ€‘900 dark:textâ€‘grayâ€‘100">{value}</div>
      {trend!==undefined && <LineChart width={80} height={24} data={data}><Line type="monotone" dataKey="v" stroke="#3b82f6" strokeWidth={2} dot={false}/></LineChart>}
    </div>
  );
}

// ---------------- client/components/matrix/SectionMatrix.jsx ----------------
import React from 'react';
export default function SectionMatrix({ matrix }){
  /* matrix: [{section:'2.7.1', signer:'QA', status:'Signed'}, â€¦ ] */
  return (
    <table className="textâ€‘xs borderâ€‘collapse wâ€‘full bgâ€‘white dark:bgâ€‘grayâ€‘800">
      <thead><tr><th>Section</th><th>Author</th><th>Signer</th><th>Status</th></tr></thead>
      <tbody>{matrix.map(r=><tr key={r.section} className="borderâ€‘b"><td>{r.section}</td><td>{r.author}</td><td>{r.signer}</td><td><StatusChip status={r.status}/></td></tr>)}</tbody>
    </table>
  );
}

// ---------------- client/pages/SubmissionHome.jsx ----------------
import React, { useEffect } from 'react';
import { useQuery } from '@tanstack/reactâ€‘query';
import { supabase } from '@/lib/supa';
import SectionMatrix from '../components/matrix/SectionMatrix.jsx';
import Timeline from '../components/charts/Timeline.jsx';
import EsgPanel from '../components/EsgPanel.jsx';
export default function SubmissionHome({ params }){
  const { data:sub } = useQuery(['ind',params.id], async()=> (await supabase.from('ind_wizards').select('*').eq('id',params.id).single()).data );
  const { data:matrix=[] } = useQuery(['matrix',params.id], async()=> (await supabase.rpc('fn_section_matrix',{sub_id:params.id})).data );
  if(!sub) return null;
  return (
    <div className="pâ€‘8 spaceâ€‘yâ€‘6">
      <h1 className="textâ€‘3xl fontâ€‘bold mbâ€‘2">{sub.product_name} â€“ {sub.region}</h1>
      <div className="grid gridâ€‘colsâ€‘1 md:gridâ€‘colsâ€‘3 gapâ€‘6">
        <div className="md:colâ€‘spanâ€‘2 bgâ€‘white dark:bgâ€‘grayâ€‘800 rounded shadow pâ€‘4"><SectionMatrix matrix={matrix}/></div>
        <div className="spaceâ€‘yâ€‘4">
          <EsgPanel submissionId={params.id}/>
          <div className="bgâ€‘white dark:bgâ€‘grayâ€‘800 rounded shadow pâ€‘4"><h3 className="fontâ€‘semibold mbâ€‘2">Ledger</h3><Timeline submissionId={params.id}/></div>
        </div>
      </div>
    </div>
  );
}

// ---------------- client/components/charts/Timeline.jsx ----------------
import React, { useEffect, useState } from 'react';
import axios from 'axios';
export default function Timeline({ submissionId }){
  const [events,set]=useState([]);
  useEffect(()=>{ axios.get(`/api/ledger/${submissionId}`).then(r=>set(r.data)); },[submissionId]);
  return (<ul className="spaceâ€‘yâ€‘2 textâ€‘xs maxâ€‘hâ€‘64 overflowâ€‘auto">
    {events.map(e=>(<li key={e.id} className="borderâ€‘lâ€‘2 plâ€‘2 borderâ€‘blueâ€‘500"><span className="fontâ€‘bold textâ€‘blueâ€‘600">{e.event_type}</span> â€“ {e.payload.summary||''} <span className="textâ€‘grayâ€‘500">{new Date(e.ts).toLocaleString()}</span></li>))}
  </ul>);
}

// ---------------- client/components/widgets/ToastCenter.jsx ----------------
// lightweight toast center using Supabase realtime for ESG ACK
import { useEffect } from 'react';
import { createPortal } from 'reactâ€‘dom';
import { supabase } from '@/lib/supa';
export default function ToastCenter(){
  useEffect(()=>{
    const ch = supabase.channel('esg_toast')
      .on('postgres_changes',{ event:'UPDATE', table:'esg_queue' }, payload=>{
        const q=payload.new; if(['Ack1','Ack2','Ack3'].includes(q.status)) show(`ESG ${q.status} received for ${q.id.slice(0,8)}`);
      }).subscribe();
    return ()=> supabase.removeChannel(ch);
  },[]);
  const show=msg=>{
    const el=document.createElement('div'); el.className='toast'; el.textContent=msg; document.body.appendChild(el);
    setTimeout(()=>el.remove(),5000);
  };
  return createPortal(null, document.body);
}

// ---------------- Routing Setup (example) ----------------
import AppShell from './layout/AppShell.jsx';
import IndDashboard from './pages/IndDashboard.jsx';
import SubmissionHome from './pages/SubmissionHome.jsx';
import { Route }
